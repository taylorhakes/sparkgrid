<!DOCTYPE HTML>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <title>SlickGrid example 6: AJAX Load</title>
  <link rel="stylesheet" href="../css/spark.css" type="text/css"/>
  <link rel="stylesheet" href="examples.css" type="text/css"/>
  <style>
    .cell-story {
      white-space: normal !important;
      line-height: 19px !important;
    }

    .loading-indicator {
      display: inline-block;
      padding: 12px;
      background: white;
      -opacity: 0.5;
      color: black;
      font-weight: bold;
      z-index: 9999;
      border: 1px solid red;
      -moz-border-radius: 10px;
      -webkit-border-radius: 10px;
      -moz-box-shadow: 0 0 5px red;
      -webkit-box-shadow: 0px 0px 5px red;
      -text-shadow: 1px 1px 1px white;
    }

    .loading-indicator label {
      padding-left: 20px;
      background: url('../images/ajax-loader-small.gif') no-repeat center left;
    }
  </style>
</head>
<body>
<div style="width:700px;float:left;">
  <div class="grid-header" style="width:100%">
    <label>Hackernews stories</label>
        <span style="float:right;display:inline-block;">
          Search:
          <input type="text" id="txtSearch" value="github">
        </span>
  </div>
  <div id="myGrid" style="width:100%;height:600px;"></div>
  <div id="pager" style="width:100%;height:20px;"></div>
</div>
<div style="margin-left:750px;margin-top:40px;;">
  <h2>Demonstrates:</h2>
  <ul>
    <li>loading data through AJAX</li>
    <li>custom row height</li>
  </ul>

  <h2>WARNING:</h2>
  <ul>
    <li>API access to Hackernews provided through ThriftDB has some latency when paging through results. Be patient.
    </li>
  </ul>

    <h2>View Source:</h2>
    <ul>
        <li><A href="https://github.com/mleibman/SlickGrid/blob/gh-pages/examples/example6-ajax-loading.html" target="_sourcewindow"> View the source for this example on Github</a></li>
    </ul>
</div>


<script src="../build/bundle.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>

<script>
	var grid;
	var loader = new Spark.RemoteModel();

	var storyTitleFormatter = function (row, cell, value, columnDef, dataContext) {
		s = "<b><a href='" + dataContext["url"] + "' target=_blank>" + dataContext["title"] + "</a></b><br/>";
		desc = dataContext["text"];
		if (desc) { // on Hackernews many stories don't have a description
			s += desc;
		}
		return s;
	};

	var dateFormatter = function (row, cell, value, columnDef, dataContext) {
		return (value.getMonth() + 1) + "/" + value.getDate() + "/" + value.getFullYear();
	};

	var columns = [
		{id: "num", name: "#", field: "index", width: 40},
		{id: "story", name: "Story", width: 520, formatter: storyTitleFormatter, cssClass: "cell-story"},
		{id: "date", name: "Date", field: "create_ts", width: 60, formatter: dateFormatter, sortable: true},
		{id: "points", name: "Points", field: "points", width: 60, sortable: true}
	];

	var options = {
		rowHeight: 64,
		editable: false,
		enableAddRow: false,
		enableCellNavigation: false
	};

	var loadingIndicator = null, label;

	grid = new Spark.Grid("#myGrid", loader.data, columns, options);

	grid.onViewportChanged.subscribe(function (e, args) {
		var vp = grid.getViewport();
		loader.ensureData(vp.top, vp.bottom);
	});

	grid.onSort.subscribe(function (e, args) {
		loader.setSort(args.sortCol.field, args.sortAsc ? 1 : -1);
		var vp = grid.getViewport();
		loader.ensureData(vp.top, vp.bottom);
	});

	loader.onDataLoading.subscribe(function () {
		if (!loadingIndicator) {
			loadingIndicator = Spark.createEl({
				tag: 'span',
				className: 'loading-indicator'
			});
			label = Spark.createEl({
				tag: 'label',
				textContent: 'Buffering...'
			});
			loadingIndicator.appendChild(label);
			document.body.appendChild(loadingIndicator);

			var g = document.getElementById("myGrid");

			Spark.setStyle(loadingIndicator, {
				"position": "absolute",
				"top": g.offsetTop + g.clientHeight / 2 - loadingIndicator.clientHeight / 2,
				"left": g.offsetLeft + g.clientWidth / 2 - loadingIndicator.clientHeight / 2
			});
		}

		loadingIndicator.style.display = '';
	});

	loader.onDataLoaded.subscribe(function (e, args) {
		for (var i = args.from; i <= args.to; i++) {
			grid.invalidateRow(i);
		}

		grid.updateRowCount();
		grid.render();

		loadingIndicator.fadeOut();
	});

	var txtSearch = document.getElementById("txtSearch")

	txtSearch.addEventListener('keyup', function (e) {
		if (e.which == 13) {
			loader.setSearch(e.target.value);
			var vp = grid.getViewport();
			loader.ensureData(vp.top, vp.bottom);
		}
	});

	loader.setSearch(txtSearch.value);
	loader.setSort("create_ts", -1);
	grid.setSortColumn("date", false);

	// load the first page
	grid.onViewportChanged.notify();
</script>
</body>
</html>
